language: go

services:
  - docker

go:
  - "1.10"

before_install:
  - bash bin/install-protobuf.sh
  - go get -u github.com/golang/dep/cmd/dep
  - go get -u github.com/golang/protobuf/protoc-gen-go
  - go get -u github.com/micro/protoc-gen-micro
  - export PATH=$PATH:$HOME/protobuf/bin

jobs:
  include:
    - stage: ensure dependencies
      script:
        - dep ensure -v

    - stage: compile protobuf
      script:
        - make proto

    - stage: build user
      script:
        - make user

    - stage: build mail
      script:
        - make mail

    - stage: build video
      script:
        - make video

    - stage: build transcode
      script:
        - make transcode

    - stage: build docker dev images
      script:
        - make docker

    - stage: push docker images
      script:
        - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME"
        - make docker-push-dev

