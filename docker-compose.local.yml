version: "3.4"

services:

  # Consul dev container
  consul:
    image: consul
    ports:
      - 8500:8500

  # MongoDB dev container
  mongodb:
    image: mongo:latest
    command: mongod
    ports:
      - 27017:27017

  # micro api gateway
  micro:
    command: --registry_address=consul:8500 api --handler=rpc --namespace=educonn.api
    image: microhq/micro:latest
    ports:
      - 8080:8080
    depends_on:
      - consul
    environment:
      TZ: Europe/Berlin
      MICRO_REGISTRY: consul
      MICRO_REGISTRY_ADDRESS: consul:8500

  # [educonn] user service
  user:
    image: derwaldemar/educonn-user:latest-staging
    depends_on:
      - consul
    environment:
      DEV_ENV: 1
      TZ: Europe/Berlin
      MICRO_REGISTRY: consul
      MICRO_REGISTRY_ADDRESS: consul:8500
      MICRO_BROKER: rabbitmq
      MICRO_BROKER_ADDRESS: amqp://ccqcaopy:0RUtNCAQZ4YCsVnoswu1M9uqLyhOeDCX@sheep.rmq.cloudamqp.com/ccqcaopy
      JWT_EXPIRE_SECONDS: 15000
      PRIVATE_KEY_PATH: /app/auth.rsa
      PUBLIC_KEY_PATH: /app/auth.rsa.pub
      DB_HOST: mongodb.educonn.de
      DB_PORT: 27017
      DB_NAME: users
      DB_USER: users
      DB_PASS: KLnob2hZTCAwC1rwNryV
      JWT_EXPIRE_SECONDS: 15000
      ZIPKIN_COLLECTOR_URL: http://localhost:9411/api/v1/spans
    volumes:
      - ./educonn_auth.rsa:/app/auth.rsa
      - ./educonn_auth.rsa.pub:/app/auth.rsa.pub

  # [educonn] user api service
  user-api:
    image: derwaldemar/educonn-user-api:latest-staging
    depends_on:
      - consul
    environment:
      TZ: Europe/Berlin
      MICRO_REGISTRY: consul
      MICRO_REGISTRY_ADDRESS: consul
      AUTH_PUBLIC_KEY_PATH: /app/auth.rsa.pub
    volumes:
      - ./api/user/cmd/user-apid/.env-docker:/app/.env
      - ./educonn_auth.rsa.pub:/app/auth.rsa.pub

  # [educonn] mail service
  mail:
    image: derwaldemar/educonn-mail:latest-staging
    depends_on:
      - consul
    environment:
      TZ: Europe/Berlin
      MICRO_REGISTRY: consul
      MICRO_REGISTRY_ADDRESS: consul
      MICRO_BROKER: rabbitmq
      MICRO_BROKER_ADDRESS: amqp://ccqcaopy:0RUtNCAQZ4YCsVnoswu1M9uqLyhOeDCX@sheep.rmq.cloudamqp.com/ccqcaopy
      SMTP_HOST: smtp.mailtrap.io
      SMTP_PORT: 2525
      SMTP_USER: 0f92ba981e4a2f
      SMTP_PASS: 09f0dcb79f8f24
      AUTH_PUBLIC_KEY_PATH: /app/auth.rsa.pub
      MAIL_TEMPLATE_PATH: /app/templates
    volumes:
      - ./mail/cmd/maild/.env-docker:/app/.env
      - ./educonn_auth.rsa.pub:/app/auth.rsa.pub
      - ./mail/templates:/app/templates

  # [educonn] video service
  video:
    image: derwaldemar/educonn-video:latest-staging
    depends_on:
      - consul
    environment:
      TZ: Europe/Berlin
      MICRO_REGISTRY: consul
      MICRO_REGISTRY_ADDRESS: consul
      MICRO_BROKER: rabbitmq
      MICRO_BROKER_ADDRESS: amqp://ccqcaopy:0RUtNCAQZ4YCsVnoswu1M9uqLyhOeDCX@sheep.rmq.cloudamqp.com/ccqcaopy
      AWS_ACCESS_KEY: AKIAIRN3LRRR4KKFJYYA
      AWS_SECRET_KEY: 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
      AWS_REGION: eu-west-1
      AWS_S3_VIDEO_BUCKET: videos.educonn.de
      AUTH_PUBLIC_KEY_PATH: /app/auth.rsa.pub
      DB_HOST: mongodb.educonn.de
      DB_PORT: 27017
      DB_NAME: videos
      DB_USER: videos
      DB_PASS: 7P2i1x4WguWJdMIzIVHG
    volumes:
      - ./video/cmd/videod/.env-docker:/app/.env
      - ./educonn_auth.rsa.pub:/app/auth.rsa.pub

  # [educonn] transcode service
  transcode:
    image: derwaldemar/educonn-transcode:latest-staging
    depends_on:
      - consul
    environment:
      TZ: Europe/Berlin
      MICRO_REGISTRY: consul
      MICRO_REGISTRY_ADDRESS: consul
      MICRO_BROKER: rabbitmq
      MICRO_BROKER_ADDRESS: amqp://ccqcaopy:0RUtNCAQZ4YCsVnoswu1M9uqLyhOeDCX@sheep.rmq.cloudamqp.com/ccqcaopy
      AWS_ACCESS_KEY: AKIAJYVKJTTWUTSFTXYA
      AWS_SECRET_KEY: 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
      AWS_REGION: eu-west-1
      AWS_TRANSCODE_PRESET: 1351620000001-100070
      AWS_TRANSCODE_PIPELINE: 1532629797407-jfd8uk
      AWS_TRANSCODE_OUTPUT_PREFIX: transcoded/
      AWS_VIDEO_QUEUE: educonn-videos
      AUTH_PUBLIC_KEY_PATH: /app/auth.rsa.pub
      DB_HOST: mongodb.educonn.de
      DB_PORT: 27017
      DB_NAME: transcode
      DB_USER: transcode
      DB_PASS: SJC4AUxF2F0r40ko2kF0
    volumes:
      - ./transcode/cmd/transcoded/.env-docker:/app/.env
      - ./educonn_auth.rsa.pub:/app/auth.rsa.pub

  # [eudconn] lesson service
  lesson:
    image: derwaldemar/educonn-lesson:dev
    depends_on:
      - consul
    environment:
      TZ: Europe/Berlin
      MICRO_REGISTRY: consul
      MICRO_REGISTRY_ADDRESS: consul
      MICRO_BROKER: rabbitmq
      MICRO_BROKER_ADDRESS: amqp://ccqcaopy:0RUtNCAQZ4YCsVnoswu1M9uqLyhOeDCX@sheep.rmq.cloudamqp.com/ccqcaopy
      DB_HOST: mongodb
      DB_PORT: 27017
      DB_NAME: lessons
      DB_USER: lessons
    volumes:
      - ./transcode/cmd/transcoded/.env-docker:/app/.env
