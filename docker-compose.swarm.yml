version: "3.4"

secrets:
    user-secrets-01:
      external: true
    transcode-secrets-02:
      external: true
    mail-secrets-01:
      external: true
    video-secrets-01:
      external: true
    educonn-auth-rsa:
      external: true
    educonn-auth-pub:
      external: true

services:

  ## API Gateway
  micro-api:
    command: api --handler=rpc
    image: microhq/micro:latest
    ports:
      - 8080:8080
    environment:
      TZ: Europe/Berlin
      MICRO_REGISTRY: consul
      MICRO_REGISTRY_ADDRESS: cluster
      MICRO_API_NAMESPACE: educonn.api
    networks:
      - consul
    deploy:
      mode: global

  ## WEB Gateway
  micro-web:
    command: web
    image: microhq/micro:latest
    ports:
      - 8082:8082
    environment:
      TZ: Europe/Berlin
      MICRO_REGISTRY: consul
      MICRO_REGISTRY_ADDRESS: cluster
      MICRO_NAMESPACE: educonn.api
    networks:
      - consul
    deploy:
      mode: global

  ## USER service
  user:
    image: derwaldemar/educonn-user:latest-staging
    secrets:
      - source: user-secrets-01
        target: /app/.env
      - source: educonn-auth-rsa
        target: /app/auth.rsa
      - source: educonn-auth-pub
        target: /app/auth.rsa.pub
    environment:
      TZ: Europe/Berlin
      MICRO_REGISTRY: consul
      MICRO_REGISTRY_ADDRESS: cluster
      MICRO_BROKER: rabbitmq
      JWT_EXPIRE_SECONDS: 15000
      DB_HOST: mongodb.educonn.de
      DB_PORT: 27017
      DB_NAME: users
      DB_USER: users
      DB_PASS: KLnob2hZTCAwC1rwNryV
      PRIVATE_KEY_PATH: /app/auth.rsa
      PUBLIC_KEY_PATH: /app/auth.rsa.pub
    networks:
      - consul

  # USER-API service
  user-api:
    image: derwaldemar/educonn-user-api:latest-staging
    environment:
      TZ: Europe/Berlin
      MICRO_REGISTRY: consul
      MICRO_REGISTRY_ADDRESS: cluster
      AUTH_PUBLIC_KEY_PATH: /app/auth.rsa.pub
    secrets:
      - source: educonn-auth-pub
        target: /app/auth.rsa.pub
    networks:
      - consul

  # MAIL service
  mail:
    image: derwaldemar/educonn-mail:latest-staging
    environment:
      TZ: Europe/Berlin
      MICRO_REGISTRY: consul
      MICRO_REGISTRY_ADDRESS: cluster
      MICRO_BROKER: rabbitmq
      SMTP_HOST: smtp.mailtrap.io
      SMTP_PORT: 2525
      AUTH_PUBLIC_KEY_PATH: /app/auth.rsa.pub
      MAIL_TEMPLATE_PATH: /app/templates
    secrets:
      - source: mail-secrets-01
        target: /app/.env
      - source: educonn-auth-pub
        target: /app/auth.rsa.pub
    networks:
      - consul

  ## VIDEO service
  video:
    image: derwaldemar/educonn-video:latest-staging
    environment:
      TZ: Europe/Berlin
      MICRO_REGISTRY: consul
      MICRO_REGISTRY_ADDRESS: cluster
      MICRO_BROKER: rabbitmq
      AWS_REGION: eu-west-1
      AWS_S3_VIDEO_BUCKET: videos.educonn.de
      AUTH_PUBLIC_KEY_PATH: /app/auth.rsa.pub
      DB_HOST: mongodb.educonn.de
      DB_PORT: 27017
      DB_NAME: videos
      DB_USER: videos
      DB_PASS: 7P2i1x4WguWJdMIzIVHG
    secrets:
      - source: video-secrets-01
        target: /app/.env
      - source: educonn-auth-pub
        target: /app/auth.rsa.pub
    networks:
      - consul

  # VIDEO-API service
  video-api:
    image: derwaldemar/educonn-video-api:latest-staging
    environment:
      TZ: Europe/Berlin
      MICRO_REGISTRY: consul
      MICRO_REGISTRY_ADDRESS: cluster
      AUTH_PUBLIC_KEY_PATH: /app/auth.rsa.pub
    secrets:
      - source: educonn-auth-pub
        target: /app/auth.rsa.pub
    networks:
      - consul

  ## TRANSCODE service
  transcode:
    image: derwaldemar/educonn-transcode:latest-staging
    environment:
      TZ: Europe/Berlin
      MICRO_REGISTRY: consul
      MICRO_REGISTRY_ADDRESS: cluster
      MICRO_BROKER: rabbitmq
      AWS_REGION: eu-west-1
      AWS_TRANSCODE_PRESET: 1351620000001-100070
      AWS_TRANSCODE_PIPELINE: 1532629797407-jfd8uk
      AWS_TRANSCODE_OUTPUT_PREFIX: transcoded/
      AWS_VIDEO_QUEUE: educonn-videos
      DB_HOST: mongodb.educonn.de
      DB_PORT: 27017
      DB_NAME: transcode
      DB_USER: transcode
      DB_PASS: SJC4AUxF2F0r40ko2kF0
    secrets:
      - source: transcode-secrets-02
        target: /app/.env
    networks:
      - consul

networks:
  default:
    external:
      name: educonn-backend
  consul:
    external:
      name: consul